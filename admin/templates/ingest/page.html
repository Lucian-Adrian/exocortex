{% extends "layouts/main.html" %}

{% block page_title %}Ingest Content{% endblock %}

{% block breadcrumbs %}
<span class="text-gray-400 mx-2">/</span>
<span class="text-gray-500">Ingest</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center">
            <span class="material-symbols-outlined mr-2 text-green-500">upload</span>
            Ingest Content
        </h1>
        <p class="text-gray-500 mt-1">Add new content to your memory store. Content will be enriched and embedded automatically.</p>
    </div>

    <!-- Success/Error Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Tabs -->
    <div x-data="{ tab: 'text' }">
        <div class="flex border-b border-gray-200 dark:border-gray-700">
            <button @click="tab = 'text'" :class="tab === 'text' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'" class="px-4 py-3 border-b-2 font-medium text-sm">
                <span class="material-symbols-outlined align-middle mr-1">edit_note</span> Text
            </button>
            <button @click="tab = 'file'" :class="tab === 'file' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'" class="px-4 py-3 border-b-2 font-medium text-sm">
                <span class="material-symbols-outlined align-middle mr-1">upload_file</span> File Upload
            </button>
            <button @click="tab = 'json'" :class="tab === 'json' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'" class="px-4 py-3 border-b-2 font-medium text-sm">
                <span class="material-symbols-outlined align-middle mr-1">data_object</span> JSON
            </button>
        </div>

        <!-- Text Tab -->
        <div x-show="tab === 'text'" class="bg-gray-50 dark:bg-gray-800 rounded-b-lg p-6">
            <form method="post" action="{% url 'ingest:submit' %}">
                {% csrf_token %}
                <input type="hidden" name="ingest_type" value="text">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Content</label>
                        <textarea name="content" rows="10" required
                            placeholder="Paste or type your content here...&#10;&#10;Examples:&#10;- Meeting notes&#10;- Ideas or thoughts&#10;- Important information&#10;- Anything you want to remember"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source Type</label>
                            <select name="source_type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="manual">Manual Entry</option>
                                <option value="note">Note</option>
                                <option value="meeting">Meeting Notes</option>
                                <option value="email">Email</option>
                                <option value="chat">Chat/Message</option>
                                <option value="document">Document</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source Description (optional)</label>
                            <input type="text" name="source_file" placeholder="e.g., Team standup 2024-01-15"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center">
                            <span class="material-symbols-outlined mr-1">upload</span>
                            Ingest Content
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- File Upload Tab -->
        <div x-show="tab === 'file'" class="bg-gray-50 dark:bg-gray-800 rounded-b-lg p-6">
            <form method="post" action="{% url 'ingest:submit' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="ingest_type" value="file">
                
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-purple-400 transition-colors">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2 block">cloud_upload</span>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Drag and drop files here, or click to select</p>
                        <input type="file" name="files" multiple accept=".txt,.md,.json,.csv"
                            class="w-full max-w-xs mx-auto">
                        <p class="text-sm text-gray-500 mt-2">Supported: .txt, .md, .json, .csv</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Source Type</label>
                        <select name="source_type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="file">File Upload</option>
                            <option value="document">Document</option>
                            <option value="export">Data Export</option>
                        </select>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center">
                            <span class="material-symbols-outlined mr-1">upload_file</span>
                            Upload & Ingest
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- JSON Tab -->
        <div x-show="tab === 'json'" class="bg-gray-50 dark:bg-gray-800 rounded-b-lg p-6">
            <form method="post" action="{% url 'ingest:submit' %}">
                {% csrf_token %}
                <input type="hidden" name="ingest_type" value="json">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">JSON Data</label>
                        <textarea name="json_content" rows="12" required
                            placeholder='{
  "content": "Your content here",
  "source_type": "api",
  "metadata": {
    "key": "value"
  }
}'
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">Expected Format</h4>
                        <pre class="text-sm text-blue-700 dark:text-blue-300 overflow-x-auto">{
  "content": "string (required)",
  "source_type": "string (optional)",
  "source_file": "string (optional)",
  "metadata": { } // optional
}</pre>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center">
                            <span class="material-symbols-outlined mr-1">data_object</span>
                            Ingest JSON
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Ingests -->
    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Recent Ingests</h3>
        <div class="space-y-3">
            {% for memory in recent_memories %}
            <div class="flex items-center justify-between bg-white dark:bg-gray-900 rounded-lg p-3">
                <div>
                    <p class="text-gray-800 dark:text-white font-medium">{{ memory.summary|default:"Processing..."|truncatewords:10 }}</p>
                    <p class="text-sm text-gray-500">{{ memory.created_at|date:"M d, Y H:i" }} Â· {{ memory.source_type }}</p>
                </div>
                <a href="{% url 'memories:detail' memory.id %}" class="text-purple-500 hover:text-purple-700">
                    <span class="material-symbols-outlined">visibility</span>
                </a>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-4">No recent ingests</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
